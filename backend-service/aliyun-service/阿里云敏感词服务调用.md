# 0717——技术探索 + 沉淀：阿里云敏感词服务调用

#### 前言

阿里云提供了敏感词检测的 sdk，Java 可以通过调用直接进行检测并通过检测结果判断敏感词涉及类型。

因为这个直接可以直接使用，我们直接提供可以落地的代码示例，不进行原理解释

#### 引用示例

##### 依赖引入

##### Config 文件

```java
import com.aliyun.green20220302.Client;
import com.aliyun.teaopenapi.models.Config;
import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * @author 王玉涛
 * @Classname AliyunGreenConfig
 * @Description 阿里云内容安全（Green）服务的配置类
 *              用于加载配置文件中的认证信息和区域信息，并初始化阿里云 Green SDK 客户端
 * @Date 2025/7/17 15:42
 */
@Data
@Configuration
@ConfigurationProperties(prefix = "aliyun.green")
public class AliyunGreenConfig {

    /**
     * 阿里云 AccessKeyId：用于身份认证的密钥 ID
     */
    private String accessKeyId;

    /**
     * 阿里云 AccessKeySecret：用于签名和鉴权的密钥 Secret
     */
    private String accessKeySecret;

    /**
     * 阿里云服务区域 ID，如 "cn-shanghai"
     */
    private String regionId;

    /**
     * 阿里云 Green 服务的 Endpoint 地址，用于指定 API 请求域名
     */
    private String endpoint;

    /**
     * 阿里云 Green 服务的 Service ID，用于标识是用户的检测服务
     */
    private String userServiceId;

    /**
     * 阿里云 Green 服务的 AI Service ID，用于标识是用户的 AI 服务
     */
    private String aiServiceId;
    
    /**
     * 创建并配置阿里云 Green SDK 的 Config 对象
     * @return 配置好的 Config 实例
     */
    @Bean
    public Config greenConfig() {
        return new Config()
                .setAccessKeyId(accessKeyId)
                .setAccessKeySecret(accessKeySecret)
                .setRegionId(regionId)
                .setEndpoint(endpoint);
    }
    
    /**
     * 根据配置创建阿里云 Green SDK 的 Client 客户端实例
     * @return 配置好的 Client 实例
     * @throws Exception 初始化过程中可能出现的异常
     */
    @Bean
    public Client aliyunGreenClient() throws Exception {
        return new Client(greenConfig());
    }
}
```

##### application.yml 文件

```yaml
aliyun:
  green: # 敏感词检测根属性
    access-key-id: ${ALIBABA_CLOUD_ACCESS_KEY_ID}
    access-key-secret: ${ALIBABA_CLOUD_ACCESS_KEY_SECRET}
    region-id: cn-beijing # 默认区域
    endpoint: green-cip.cn-beijing.aliyuncs.com
    user-service-id: chat_detection_pro_01 # 对用户进行敏感词检测
    ai-service-id: aigc_moderation_byllm_01 # 对AI进行敏感词检测
```

##### GreenProvider 接口提供

```java
/**
 * @author 王玉涛
 * @InterfaceName GreenProvider
 * @Description 提供绿色内容审核服务的接口，用于对接第三方内容安全风控系统
 * @Date 2025/7/17 15:56
 * 该接口定义了基础的内容风险识别能力，包括：
 * - 文本内容审核
 * - 多媒体资源审核
 * - 风险等级判定
 * - 敏感词过滤等功能
 */
public interface GreenProvider {

    /**
     * 文本内容审核:
     *  high 高风险,建议直接拦截或删除,涉政、暴恐、色情等明确违规内容
     *  medium 中风险, 建议人工复核, 低俗、广告、敏感词命中自定义库等
     *  low 低风险, 可选择性处理, 轻微违规或边缘性内容（如无意义灌水）
     * @param text 文本内容
     * @return 审核结果
     */
    String userTextScan(String text);

    /**
     * AI文本内容审核, 默认调用阿里云
     * @param text 文本内容
     * @return 审核结果
     */
    String aiTextScan(String text);

    /**
     * 文本内容审核并返回对应回复:
     *  high 高风险,建议直接拦截或删除,涉政、暴恐、色情等明确违规内容
     *  medium 中风险, 建议人工复核, 低俗、广告、敏感词命中自定义库等
     *  low 低风险, 可选择性处理, 轻微违规或边缘性内容（如无意义灌水）
     * @param text 文本内容
     * @return 审核结果对应的回复
     */
    String userTextScanAndReply(String text);

    /**
     * 文本内容审核并返回对应回复:
     *  high 高风险,建议直接拦截或删除,涉政、暴恐、色情等明确违规内容
     *  medium 中风险, 建议人工复核, 低俗、广告、敏感词命中自定义库等
     *  low 低风险, 可选择性处理, 轻微违规或边缘性内容（如无意义灌水）
     * @param text 文本内容
     * @return 审核结果对应的回复
     */
    String aiTextScanAndReply(String text);
}
```

##### 实现类提供

```java
package com.project.demo.common.provider.impl;

import com.alibaba.fastjson2.JSONObject;
import com.aliyun.green20220302.Client;
import com.aliyun.green20220302.models.TextModerationPlusRequest;
import com.aliyun.green20220302.models.TextModerationPlusResponse;
import com.aliyun.green20220302.models.TextModerationPlusResponseBody;
import com.project.demo.common.config.ai.doubao.DoubaoGreenReply;
import com.project.demo.common.config.aliyun.AliyunGreenConfig;
import com.project.demo.common.model.enums.TextScanResultEnum;
import com.project.demo.common.provider.GreenProvider;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

import java.util.UUID;

/**
 * @author by 王玉涛
 * @Classname GreenAliyunProvider
 * @Description 阿里云内容安全审核服务实现类，对接阿里云Green API
 *              提供文本内容风险检测功能，包括用户输入和AI生成内容的审核
 * @Date 2025/7/17 15:56
 */
@Component
@RequiredArgsConstructor
@Slf4j
public class GreenAliyunProvider implements GreenProvider {

    private final Client aliyunGreenClient;
    private final AliyunGreenConfig aliyunGreenConfig;

    /**
     * 用户文本内容审核方法
     * 根据预定义规则对用户输入文本进行风险等级评估
     *
     * @param text 待审核的文本内容
     * @return 返回风险等级标识（high/medium/low）
     */
    @Override
    public String userTextScan(String text) {
        return textScan(text, aliyunGreenConfig.getUserServiceId());
    }

    /**
     * AI生成文本内容审核方法
     * 调用阿里云内容安全服务对AI生成的文本进行风险检测
     *
     * @param text 待审核的AI生成文本
     * @return 返回风险等级标识（high/medium/low）
     */
    @Override
    public String aiTextScan(String text) {
        return textScan(text, aliyunGreenConfig.getAiServiceId());
    }

    /**
     * 用户文本内容审核并返回处理建议
     * 如果内容通过审核则返回null，否则返回预设的拦截回复语
     *
     * @param text 文本内容
     * @return 审核结果对应的回复信息
     */
    @Override
    public String userTextScanAndReply(String text) {
        String textScan = textScan(text, aliyunGreenConfig.getUserServiceId());
        if (scanPassed(textScan)) {
            // 内容合规，直接返回null表示无需特殊处理
            return null;
        }
        // 内容不合规，返回用户提示语
        return DoubaoGreenReply.USER_GREEN_REPLY;
    }

    /**
     * 用户文本内容合规性检测
     * @param textScan 检测结果
     * @return 是否合规
     */
    private boolean scanPassed(String textScan) {
        return TextScanResultEnum.PASS.getCode().equals(textScan) ||
                TextScanResultEnum.NONE.getCode().equals(textScan);
    }

    /**
     * AI生成文本内容审核并返回处理建议
     * 如果内容通过审核则返回null，否则返回预设的AI友好型拦截回复语
     *
     * @param text 文本内容
     * @return 审核结果对应的回复信息
     */
    @Override
    public String aiTextScanAndReply(String text) {
        String textScan = textScan(text, aliyunGreenConfig.getAiServiceId());
        if (scanPassed(textScan)) {
            // AI生成内容合规，无需特殊处理
            return null;
        }
        // AI生成内容不合规，返回友好的引导性回复
        return DoubaoGreenReply.AI_GREEN_REPLY;
    }

    /**
     * 执行文本内容安全检测的核心方法
     * 构建请求参数 -> 发送检测请求 -> 处理响应结果 -> 返回风险等级
     *
     * @param text      待检测的文本内容
     * @param serviceId 服务ID标识（用户服务或AI服务）
     * @return 返回文本的风险等级标识（high/medium/low）
     */
    private String textScan(String text, String serviceId) {
        // 构建请求参数
        JSONObject jsonObject = new JSONObject();
        jsonObject.putIfAbsent("content", text);
        jsonObject.putIfAbsent("dataId", UUID.randomUUID());

        // 创建文本审核请求对象
        TextModerationPlusRequest request = new TextModerationPlusRequest()
                .setService(serviceId)
                .setServiceParameters(jsonObject.toJSONString());

        TextModerationPlusResponse response = null;
        try {
            // 发送文本审核请求
            response = aliyunGreenClient.textModerationPlus(request);
        } catch (Exception e) {
            log.error("文本检测失败：{}", e.getMessage(), e);
            throw new RuntimeException("文本检测失败！");
        }

        // 检查HTTP响应状态码是否为成功状态
        Integer successCode = 200;
        if (!(response != null && response.getStatusCode().equals(successCode))) {
            log.warn("文本检测响应状态异常：{}", response != null ? response.getStatusCode() : "null");
            throw new RuntimeException("文本检测失败！");
        }

        // 获取响应体
        TextModerationPlusResponseBody responseBody = response.getBody();

        // 检查业务状态码是否为成功状态
        if (!responseBody.getCode().equals(successCode)) {
            log.warn("文本检测业务状态异常：{}", responseBody.getCode());
            throw new RuntimeException("文本检测失败！");
        }

        // 返回最终的风险等级判断结果
        return responseBody.getData().getRiskLevel();
    }
}
```

##### 对应的 enum 类提供

```java
package com.project.demo.common.model.enums;

import lombok.AllArgsConstructor;
import lombok.Getter;

/**
 * @author 王玉涛
 * @Classname TextScanResultEnum
 * @Description 文本审核结果枚举类，用于表示文本内容的安全级别和审核状态
 * @Date 2025/7/17 16:25
 * 
 * 枚举值说明：
 * - PASS: 审核通过，内容安全
 * - REVIEW: 需要人工复核，可能存在潜在风险
 * - BLOCK: 审核不通过，内容违规
 */
@Getter
@AllArgsConstructor
public enum TextScanResultEnum {

    /**
     * 无风险
     */
    NONE("none", "none", "无风险"),
    
    /**
     * 审核通过 - 低风险
     * 表示文本内容完全合规，无需额外处理
     */
    PASS("pass", "low", "正常"),
    
    /**
     * 需要复核 - 中风险
     * 表示文本内容可能存在模糊或敏感信息，建议人工复审
     */
    REVIEW("review", "medium", "疑似违规内容"),
    
    /**
     * 审核拦截 - 高风险
     * 表示文本内容明确违规，禁止通过
     */
    BLOCK("block", "high", "违规内容");

    /**
     * 用于匹配审核系统的返回标识码
     */
    private final String code;

    /**
     * 风险等级标识，用于快速判断内容安全级别
     */
    private final String level;

    /**
     * 枚举值的中文描述，用于日志记录或前端展示
     */
    private final String description;
}
```

##### 对应回复提供示例

```java
/**
 * @author by 王玉涛
 * @Classname DoubaoGreenReply
 * @Description TODO
 * @Date 2025/7/17 16:21
 */
public class DoubaoGreenReply {

    public static final String USER_GREEN_REPLY = "很抱歉，你提到的内容可能涉及一些需要谨慎对待的信息，从心理关怀的角度来说，我们更希望聚焦在积极、健康且能给彼此带来正向支持的话题上。如果你来聊聊生活中的情绪感受、人际交往中的小困扰，或者想探讨如何更好地照顾自己的心理状态，我都会认真倾听并尽力提供支持。让我们一起在安全、温暖的氛围里交流吧，感谢你的理解呀。";
    public static final String AI_GREEN_REPLY = "哎呀这个问题有点复杂呢，您可以再说一遍吗？或许换种表达方式，我们能更顺畅地聊下去。要是有什么具体的感受或想法想分享，我都在这儿认真听着，咱们慢慢梳理，总能找到合适的交流节奏呀。";
}
```

当前代码可以直接落地使用，并提供对应的方法。只需要提供对应的 application.yml 信息即可（敏感信息推荐使用环境变量注入）
